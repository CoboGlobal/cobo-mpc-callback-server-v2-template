package validator

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestSignatureVerify(t *testing.T) {

	message := "{\"_theme\":\"structured\",\"_biz_version\":\"1.0.0\",\"_post_actions\":[{\"type\":\"sign_message\",\"data\":{\"transaction_id\":\"6e716a4e-4c6b-406e-ab23-43e96b2cb021\",\"transaction_type\":\"MessageSign\"}}],\"header\":{\"title\":\"Transaction: Sign Safe{Wallet} Tx\",\"title_icon\":\"\"},\"body\":{\"components\":[{\"_component_type\":\"section\",\"components\":[{\"_component_type\":\"text\",\"_is_in_list\":true,\"key\":\"Organization\",\"data\":{\"value\":\"Portal-内部体验-4006\",\"label\":\"SANDBOX\"}},{\"_component_type\":\"text\",\"_is_in_list\":true,\"key\":\"Source\",\"data\":{\"value\":\"mzc\",\"label\":\"Org-Controlled\"}},{\"_component_type\":\"text\",\"_is_in_list\":true,\"key\":\"Initiator\",\"data\":{\"value\":null}},{\"_component_type\":\"date_time\",\"key\":\"Created Time\",\"data\":{\"value\":1761634695}},{\"_component_type\":\"text\",\"key\":\"Message ID\",\"data\":{\"value\":\"76b1f8b3-7567-4f17-b3e3-1835207b3d88\"}}]},{\"_component_type\":\"section\",\"components\":[{\"_component_type\":\"text\",\"key\":\"Transaction Type\",\"data\":{\"value\":\"MessageSign\"}},{\"_component_type\":\"text\",\"key\":\"Chain\",\"data\":{\"value\":\"MNT\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"Transaction ID\",\"data\":{\"value\":\"6e716a4e-4c6b-406e-ab23-43e96b2cb021\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"Request ID\",\"data\":{\"value\":\"SafeTx-8e217324-625a-4314-bb08-26e390c3ed33\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"Signing Address\",\"data\":{\"label\":\"\",\"value\":\"0x5393209fc04e4df32c023d9487fed571dd0b09b2\"}}]},{\"_component_type\":\"section\",\"components\":[{\"_component_type\":\"text\",\"key\":\"Safe Wallet\",\"data\":{\"value\":\"0xFE206B80432EB35ea456Ef00E36aD49C2522733F\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"safe TxHash\",\"data\":{\"value\":\"0x282d8aa485030ca6d1079c4c28e3a77ac20148767821268810f761aed679d636\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"Domain hash\",\"data\":{\"value\":\"0x51fc8173e9cac371017e16d0a998e45453c11e3329cfc18d31026ddb745fcd5e\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"Message hash\",\"data\":{\"value\":\"0xee78c35954abdfcece4318ee838fb6b0c228f023d27976ae334285a418506335\"}},{\"_component_type\":\"text\",\"key\":\"Operation\",\"data\":{\"value\":\"DelegateCall\",\"warnings\":[\"High Risk\"]}},{\"_component_type\":\"text\",\"key\":\"Nonce\",\"data\":{\"value\":\"9\"}},{\"_component_type\":\"text\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"key\":\"To\",\"data\":{\"value\":\"0x9641d764fc13c8B624c04430C7356C1C7C8102e2\",\"warnings\":[\"Never Transacted Before\"]}},{\"_component_type\":\"text\",\"key\":\"Value\",\"data\":{\"value\":\"0 MNT\"}},{\"_component_type\":\"text\",\"key\":\"Function\",\"data\":{\"value\":\"multiSend\"}},{\"_component_type\":\"paragraph\",\"key\":\"Parameters\",\"data\":[{\"name\":\"transactions\",\"type\":\"bytes\",\"value\":\"005393209fc04e4df32c023d9487fed571dd0b09b2000000000000000000000000000000000000000000000000000000174876e8000000000000000000000000000000000000000000000000000000000000000000005393209fc04e4df32c023d9487fed571dd0b09b2000000000000000000000000000000000000000000000000000000174876e8000000000000000000000000000000000000000000000000000000000000000000\",\"value_decoded\":[{\"operation\":\"Call\",\"to\":\"0x5393209FC04E4df32C023D9487FeD571dD0B09b2\",\"value\":\"0.0000001 MNT\",\"wei\":\"100000000000\",\"data\":\"0x\",\"data_decoded\":{\"method\":\"Transfer\",\"parameters\":[]},\"to_contract_name\":\"\"},{\"operation\":\"Call\",\"to\":\"0x5393209FC04E4df32C023D9487FeD571dD0B09b2\",\"value\":\"0.0000001 MNT\",\"wei\":\"100000000000\",\"data\":\"0x\",\"data_decoded\":{\"method\":\"Transfer\",\"parameters\":[]},\"to_contract_name\":\"\"}]}]},{\"_component_type\":\"foldable_panels\",\"key\":\"All Actions\",\"data\":[{\"title\":\"MultiSendCallOnly.Transfer\",\"components\":[{\"_component_type\":\"text\",\"key\":\"To\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"data\":{\"value\":\"0x5393209FC04E4df32C023D9487FeD571dD0B09b2\",\"warnings\":[\"Never Transacted Before\"]}},{\"_component_type\":\"text\",\"key\":\"Value\",\"_style\":{\"is_highlighted\":false,\"is_large_size\":false,\"is_bold\":false},\"data\":{\"value\":\"0.0000001 MNT\"}},{\"_component_type\":\"text\",\"key\":\"Function\",\"_style\":{\"is_highlighted\":false,\"is_large_size\":false,\"is_bold\":false},\"data\":{\"value\":\"Transfer\"}},{\"_component_type\":\"paragraph\",\"key\":\"Parameters\",\"_actions\":[\"copy\"],\"data\":[]}]},{\"title\":\"MultiSendCallOnly.Transfer\",\"components\":[{\"_component_type\":\"text\",\"key\":\"To\",\"_style\":{\"is_highlighted\":true,\"is_large_size\":false,\"is_bold\":false},\"_actions\":[\"copy\"],\"data\":{\"value\":\"0x5393209FC04E4df32C023D9487FeD571dD0B09b2\",\"warnings\":[\"Never Transacted Before\"]}},{\"_component_type\":\"text\",\"key\":\"Value\",\"_style\":{\"is_highlighted\":false,\"is_large_size\":false,\"is_bold\":false},\"data\":{\"value\":\"0.0000001 MNT\"}},{\"_component_type\":\"text\",\"key\":\"Function\",\"_style\":{\"is_highlighted\":false,\"is_large_size\":false,\"is_bold\":false},\"data\":{\"value\":\"Transfer\"}},{\"_component_type\":\"paragraph\",\"key\":\"Parameters\",\"_actions\":[\"copy\"],\"data\":[]}]}]},{\"_component_type\":\"text\",\"key\":\"Safe Tx Gas\",\"data\":{\"value\":\"0\"}},{\"_component_type\":\"text\",\"key\":\"Base Gas\",\"data\":{\"value\":\"0\"}},{\"_component_type\":\"text\",\"key\":\"Gas Price\",\"data\":{\"value\":\"0\"}},{\"_component_type\":\"text\",\"key\":\"Gas Token\",\"data\":{\"value\":\"MNT\"}},{\"_component_type\":\"text\",\"key\":\"Refund Receiver\",\"data\":{\"value\":\"0x0000000000000000000000000000000000000000\"}}]},{\"_component_type\":\"section\",\"components\":[{\"_component_type\":\"paragraph\",\"_actions\":[\"copy\"],\"key\":\"Message\",\"data\":[{\"types\":{\"EIP712Domain\":[{\"name\":\"chainId\",\"type\":\"uint256\"},{\"name\":\"verifyingContract\",\"type\":\"address\"}],\"SafeTx\":[{\"name\":\"to\",\"type\":\"address\"},{\"name\":\"value\",\"type\":\"uint256\"},{\"name\":\"data\",\"type\":\"bytes\"},{\"name\":\"operation\",\"type\":\"uint8\"},{\"name\":\"safeTxGas\",\"type\":\"uint256\"},{\"name\":\"baseGas\",\"type\":\"uint256\"},{\"name\":\"gasPrice\",\"type\":\"uint256\"},{\"name\":\"gasToken\",\"type\":\"address\"},{\"name\":\"refundReceiver\",\"type\":\"address\"},{\"name\":\"nonce\",\"type\":\"uint256\"}]},\"domain\":{\"chainId\":\"0x1388\",\"verifyingContract\":\"0xFE206B80432EB35ea456Ef00E36aD49C2522733F\"},\"primaryType\":\"SafeTx\",\"message\":{\"to\":\"0x9641d764fc13c8B624c04430C7356C1C7C8102e2\",\"value\":\"0\",\"data\":\"0x8d80ff0a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000aa005393209fc04e4df32c023d9487fed571dd0b09b2000000000000000000000000000000000000000000000000000000174876e8000000000000000000000000000000000000000000000000000000000000000000005393209fc04e4df32c023d9487fed571dd0b09b2000000000000000000000000000000000000000000000000000000174876e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\",\"operation\":1,\"safeTxGas\":\"0\",\"baseGas\":\"0\",\"gasPrice\":\"0\",\"gasToken\":\"0x0000000000000000000000000000000000000000\",\"refundReceiver\":\"0x0000000000000000000000000000000000000000\",\"nonce\":\"9\"}}]}]},{\"_component_type\":\"section\",\"components\":[{\"_component_type\":\"paragraph\",\"key\":\"Note\",\"_actions\":[\"copy\"],\"data\":[\"Transaction generated by cobo safe signer.\"]}]}]}}"
	pubkey := "23b587d06028392b44f65d64d39f7a8147d3ce18d962c1438b31a866538078b323cbe665a7c7da2662279e1dc8fc7ad32ac22549af1bde92457ee7ee86039601"
	signature := "20e7b81e5850def046422d6671b3caf12f1d4acc6f5bf4af29c9913f68afdd640e66ac79d434533fce298e58248ad48543c6bf81067f908cbac84516b0cead38"
	result := 2

	sv := NewSignatureValidator(message, pubkey, signature, result)
	err := sv.Verify()
	assert.NoError(t, err)
}
